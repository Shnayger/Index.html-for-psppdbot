<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        h2 {
            text-align: center;
            margin: 10px 0 15px;
            font-size: 20px;
        }
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border: 2px solid #007bff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #results {
            margin-top: 15px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            min-height: 60px;
        }
        .result-item {
            margin: 6px 0;
            padding: 6px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        .datamatrix { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .barcode { background-color: #f1f8e9; border-left: 4px solid #4caf50; }
        .parsed { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        #status {
            margin-top: 12px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            min-height: 22px;
            color: #1a237e;
        }
        #controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #finish-btn {
            background: #007bff;
            color: white;
            flex: 1;
            max-width: 200px;
        }
        #clear-btn {
            background: #6c757d;
            color: white;
            flex: 1;
            max-width: 200px;
        }
        button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <h2>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞</h2>
    <div id="reader"></div>
    
    <div id="results"></div>
    
    <div id="status">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ DataMatrix</div>
    
    <div id="controls">
        <button id="clear-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="finish-btn">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <script>
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
        }

        let step = 'datamatrix'; // 'datamatrix' –∏–ª–∏ 'barcode'
        let isScanning = true; // –§–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const resultsEl = document.getElementById('results');
        const statusEl = document.getElementById('status');
        const readerEl = document.getElementById('reader');

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function addResult(type, text, extra = '') {
            const div = document.createElement('div');
            div.className = `result-item ${type}`;
            div.textContent = `${text}${extra ? ' ‚Üí ' + extra : ''}`;
            resultsEl.appendChild(div);
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏
        function clearResults() {
            resultsEl.innerHTML = '';
            step = 'datamatrix';
            isScanning = true;
            statusEl.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ DataMatrix';
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.7777778,
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };

        // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                if (!isScanning) return;

                const code = decodedText.trim();
                if (step === 'datamatrix') {
                    isScanning = false; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                    addResult('datamatrix', 'üì¶ DataMatrix:', code);

                    // === –ü–ê–†–°–ò–ù–ì ===
                    if (code.length === 22) {
                        const uniqueId = code.substring(0, 9);
                        const gtin = code.substring(9, 22);
                        addResult('parsed', 'üî¢ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID:', uniqueId);
                        addResult('parsed', 'üè∑Ô∏è GTIN:', gtin);
                        statusEl.textContent = '‚úÖ DataMatrix —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥.';
                        step = 'barcode';
                        isScanning = true; // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
                    } else if (code.length === 30) {
                        const number = code.substring(18, 27);
                        const series = code.substring(27, 30);
                        addResult('parsed', 'üî¢ –ù–æ–º–µ—Ä –£–ö–ó:', number);
                        addResult('parsed', 'üî§ –°–µ—Ä–∏—è –£–ö–ó:', series);
                        statusEl.textContent = '‚úÖ –£–ö–ó —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥.';
                        step = 'barcode';
                        isScanning = true;
                    } else if (code.length === 35) {
                        const gtin = code.substring(3, 16);
                        addResult('parsed', 'üè∑Ô∏è GTIN –∏–∑ –°–ò:', gtin);
                        statusEl.textContent = '‚úÖ –°–ò —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥.';
                        step = 'barcode';
                        isScanning = true;
                    } else {
                        statusEl.textContent = `‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (${code.length} —Å–∏–º–≤–æ–ª–æ–≤)`;
                        isScanning = true;
                    }
                } else if (step === 'barcode') {
                    isScanning = false; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Å–ª–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
                    addResult('barcode', 'üõí –®—Ç—Ä–∏—Ö-–∫–æ–¥:', code);
                    statusEl.textContent = '‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!';
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        clearResults();
                    }, 30000);
                }
            },
            (errorMessage) => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            }
        ).catch(err => {
            statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã";
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É:", err);
        });

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('clear-btn').onclick = () => {
            html5QrCode.stop().then(() => {
                clearResults();
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
                html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => { /* —Ç–æ—Ç –∂–µ callback */ },
                    (err) => {}
                );
            });
        };
        
        document.getElementById('finish-btn').onclick = () => {
            html5QrCode.stop().then(() => {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.close();
                }
            });
        };
    </script>
</body>
</html>
