<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden; /* ‚Üê –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }
        h2 {
            text-align: center;
            margin: 8px 0 12px;
            font-size: 18px;
            font-weight: 600;
        }
        #reader {
            width: 100%;
            aspect-ratio: 4/3;
            border: 2px solid #007bff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: black;
        }
        #results-container {
            flex: 1;
            margin: 12px 0;
            max-height: 200px;
            overflow-y: auto; /* ‚Üê –°–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å */
            padding: 8px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #results {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .result-item {
            padding: 6px 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
        }
        .datamatrix { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
        .barcode { background-color: #f1f8e9; border-left: 4px solid #4caf50; }
        .parsed { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        #status {
            margin: 8px 0;
            font-size: 15px;
            font-weight: bold;
            text-align: center;
            min-height: 20px;
            color: #1a237e;
        }
        #controls {
            display: flex;
            gap: 10px;
            margin-top: auto; /* ‚Üê –ü—Ä–∏–∂–∏–º–∞–µ—Ç –∫ –Ω–∏–∑—É */
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        #finish-btn {
            background: #007bff;
            color: white;
        }
        #clear-btn {
            background: #6c757d;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        button:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div id="app">
        <h2>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞</h2>
        <div id="reader"></div>
        
        <div id="results-container">
            <div id="results"></div>
        </div>
        
        <div id="status">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ DataMatrix</div>
        
        <div id="controls">
            <button id="clear-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button id="finish-btn">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <script>
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
        }

        let step = 'datamatrix'; // 'datamatrix' –∏–ª–∏ 'barcode'
        const resultsEl = document.getElementById('results');
        const statusEl = document.getElementById('status');
        const readerEl = document.getElementById('reader');

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function addResult(type, label, value) {
            const div = document.createElement('div');
            div.className = `result-item ${type}`;
            div.textContent = `${label}: ${value}`;
            resultsEl.appendChild(div);
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏
        function clearResults() {
            resultsEl.innerHTML = '';
            step = 'datamatrix';
            statusEl.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ DataMatrix';
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
        const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.7777778,
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };

        // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
        const html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            (decodedText) => {
                const code = decodedText.trim();

                if (step === 'datamatrix') {
                    // –ü—Ä–∏–Ω–∏–º–∞–µ–º –¢–û–õ–¨–ö–û DataMatrix (22, 30, 35 —Å–∏–º–≤–æ–ª–æ–≤)
                    if ([22, 30, 35].includes(code.length)) {
                        addResult('datamatrix', 'üì¶ DataMatrix', code);
                        
                        // –ü–∞—Ä—Å–∏–Ω–≥
                        if (code.length === 22) {
                            addResult('parsed', 'üî¢ ID', code.substring(0, 9));
                            addResult('parsed', 'üè∑Ô∏è GTIN', code.substring(9, 22));
                        } else if (code.length === 30) {
                            addResult('parsed', 'üî¢ –ù–æ–º–µ—Ä –£–ö–ó', code.substring(18, 27));
                            addResult('parsed', 'üî§ –°–µ—Ä–∏—è', code.substring(27, 30));
                        } else if (code.length === 35) {
                            addResult('parsed', 'üè∑Ô∏è GTIN –∏–∑ –°–ò', code.substring(3, 16));
                        }
                        
                        statusEl.textContent = '‚úÖ DataMatrix —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥.';
                        step = 'barcode'; // ‚Üê –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥
                    }
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –≤ —Ä–µ–∂–∏–º–µ DataMatrix
                } else if (step === 'barcode') {
                    // –ü—Ä–∏–Ω–∏–º–∞–µ–º –¢–û–õ–¨–ö–û —à—Ç—Ä–∏—Ö-–∫–æ–¥ (13 —Ü–∏—Ñ—Ä)
                    if (/^\d{13}$/.test(code)) {
                        addResult('barcode', 'üõí –®—Ç—Ä–∏—Ö-–∫–æ–¥', code);
                        statusEl.textContent = '‚úÖ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!';
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ 2.5 —Å–µ–∫
                        setTimeout(() => {
                            clearResults();
                        }, 2500);
                    }
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –≤ —Ä–µ–∂–∏–º–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
                }
            },
            (errorMessage) => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            }
        ).catch(err => {
            statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã";
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É:", err);
        });

        // –ö–Ω–æ–ø–∫–∏
        document.getElementById('clear-btn').onclick = () => {
            clearResults();
        };
        
        document.getElementById('finish-btn').onclick = () => {
            html5QrCode.stop().then(() => {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.close();
                }
            });
        };
    </script>
</body>
</html>
