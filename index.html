<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–∫–µ—Ä–∞ –£–ö–ó</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            background: black;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* –ë–ª–æ–∫ –∫–∞–º–µ—Ä—ã */
        #video-container {
            position: relative;
            width: 100%;
            flex: 1;
            overflow: hidden;
            min-height: 0;
            background: #000;
        }
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ */
        #qr-reader {
            width: 100%;
            height: 100%;
            position: relative;
        }
        /* –£–≥–æ–ª–∫–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
        .corner {
            position: absolute;
            pointer-events: none;
            z-index: 10;
            top: 50%;
            left: 50%;
        }
        .corner-tl {
            transform: translate(-120px, -120px);
            width: 40px;
            height: 40px;
            border-left: 4px solid white;
            border-top: 4px solid white;
        }
        .corner-tr {
            transform: translate(80px, -120px);
            width: 40px;
            height: 40px;
            border-right: 4px solid white;
            border-top: 4px solid white;
        }
        .corner-bl {
            transform: translate(-120px, 80px);
            width: 40px;
            height: 40px;
            border-left: 4px solid white;
            border-bottom: 4px solid white;
        }
        .corner-br {
            transform: translate(80px, 80px);
            width: 40px;
            height: 40px;
            border-right: 4px solid white;
            border-bottom: 4px solid white;
        }
        /* –ü–æ–¥—Å–∫–∞–∑–∫–∞ */
        #scan-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 160px);
            width: 260px;
            text-align: center;
            color: white;
            font-size: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        /* –ö–æ–Ω—Å–æ–ª—å –¥–ª—è –ª–æ–≥–æ–≤ */
        #log-console {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            height: 200px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            font-family: monospace;
            color: #0f0;
            overflow-y: auto;
            z-index: 1000;
            display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞ */
        }
        .log-entry {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        #toggle-log {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #666;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        /* –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
        #results-container {
            background: rgba(25, 25, 25, 0.95);
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            padding: 12px;
            min-height: 120px;
            max-height: 140px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        #results {
            font-size: 14px;
            line-height: 1.5;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .result-item {
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }
        .result-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        .datamatrix-result {
            color: #00ff9d;
        }
        .barcode-result {
            color: #4da6ff;
        }
        .empty-results {
            color: #888;
            font-style: italic;
            text-align: center;
            padding: 20px 0;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        #controls {
            display: flex;
            gap: 12px;
            padding: 15px;
            background: rgba(20, 20, 20, 0.95);
        }
        button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #finish-btn {
            background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        }
        #clear-btn {
            background: linear-gradient(135deg, #6c757d, #5c636a);
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        #results-container::-webkit-scrollbar,
        #log-console::-webkit-scrollbar {
            width: 6px;
        }
        #results-container::-webkit-scrollbar-track,
        #log-console::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        #results-container::-webkit-scrollbar-thumb,
        #log-console::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        #results-container::-webkit-scrollbar-thumb:hover,
        #log-console::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body>
    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≥–æ–≤ -->
    <button id="toggle-log">üìã –õ–æ–≥</button>
    
    <!-- –ö–æ–Ω—Å–æ–ª—å –¥–ª—è –ª–æ–≥–æ–≤ -->
    <div id="log-console"></div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="app">
        <!-- –ë–ª–æ–∫ –∫–∞–º–µ—Ä—ã -->
        <div id="video-container">
            <div id="qr-reader"></div>
            <!-- –£–≥–æ–ª–∫–∏ –∫–≤–∞–¥—Ä–∞—Ç–∞ -->
            <div class="corner corner-tl"></div>
            <div class="corner corner-tr"></div>
            <div class="corner corner-bl"></div>
            <div class="corner corner-br"></div>
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ —á—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å -->
            <div id="scan-hint">–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ DataMatrix</div>
        </div>
        
        <!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div id="results-container">
            <div id="results">
                <div class="empty-results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="controls">
            <button id="clear-btn">
                <span style="font-size: 18px;">üóëÔ∏è</span>
                <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
            </button>
            <button id="finish-btn">
                <span style="font-size: 18px;">‚úÖ</span>
                <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
            </button>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–π audio –¥–ª—è –∑–≤—É–∫–æ–≤ -->
    <audio id="scan-success-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="scan-error-sound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
        }

        // –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        const logConsole = document.getElementById('log-console');
        const toggleLogBtn = document.getElementById('toggle-log');
        
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#0f0',
                error: '#f00',
                warning: '#ff0',
                success: '#0ff'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.style.color = colors[type] || colors.info;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logConsole.appendChild(logEntry);
            
            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            logConsole.scrollTop = logConsole.scrollHeight;
            
            // –¢–∞–∫–∂–µ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
            console.log(`[${timestamp}] ${message}`);
        }
        
        toggleLogBtn.addEventListener('click', () => {
            logConsole.style.display = logConsole.style.display === 'none' ? 'block' : 'none';
        });

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let step = 'datamatrix'; // 'datamatrix' –∏–ª–∏ 'barcode'
        let scanCount = 0;
        const resultsEl = document.getElementById('results');
        const resultsContainer = document.getElementById('results-container');
        const scanHintEl = document.getElementById('scan-hint');
        
        // –ó–≤—É–∫–∏
        const successSound = document.getElementById('scan-success-sound');
        const errorSound = document.getElementById('scan-error-sound');
        
        function playSound(type) {
            try {
                if (type === 'success') {
                    successSound.currentTime = 0;
                    successSound.play();
                } else if (type === 'error') {
                    errorSound.currentTime = 0;
                    errorSound.play();
                }
            } catch (e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e);
            }
        }

        // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –í–°–ï–• —Ñ–æ—Ä–º–∞—Ç–æ–≤ DataMatrix
        const config = {
            fps: 20, // –£–≤–µ–ª–∏—á–µ–Ω FPS –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            qrbox: {
                width: 300, // –ë–æ–ª—å—à–∞—è –æ–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                height: 300
            },
            rememberLastUsedCamera: true,
            supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
            
            // –í–°–ï —Ñ–æ—Ä–º–∞—Ç—ã —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤
            formatsToSupport: [
                Html5QrcodeSupportedFormats.DATA_MATRIX, // –û—Å–Ω–æ–≤–Ω–æ–π
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.CODE_93,
                Html5QrcodeSupportedFormats.CODABAR,
                Html5QrcodeSupportedFormats.ITF,
                Html5QrcodeSupportedFormats.RSS_14,
                Html5QrcodeSupportedFormats.RSS_EXPANDED,
                Html5QrcodeSupportedFormats.PDF_417,
                Html5QrcodeSupportedFormats.AZTEC,
                Html5QrcodeSupportedFormats.MAXICODE,
                Html5QrcodeSupportedFormats.QR_CODE
            ],
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
            videoConstraints: {
                width: { min: 640, ideal: 1920, max: 2560 },
                height: { min: 480, ideal: 1080, max: 1440 },
                facingMode: { exact: "environment" },
                focusMode: "continuous",
                advanced: [
                    { exposureMode: "continuous" },
                    { whiteBalanceMode: "continuous" }
                ]
            },
            
            // –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true,
                useBarCodeDetectorIfSupported: true // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
        const html5QrCode = new Html5Qrcode("qr-reader");
        let isScanning = false;
        let lastScannedCode = '';
        let lastScanTime = 0;

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ FNC1 (GS) —Å–∏–º–≤–æ–ª–æ–≤
        function cleanGS1Code(code) {
            // –£–¥–∞–ª—è–µ–º —Å–∏–º–≤–æ–ª FNC1 (GS, ASCII 29, hex 1D)
            return code.replace(/\u001d/g, '');
        }

        // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –í–°–ï–• —Ñ–æ—Ä–º–∞—Ç–æ–≤ DataMatrix —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
        function analyzeDataMatrix(code) {
            const cleanCode = cleanGS1Code(code);
            const length = cleanCode.length;
            
            logToConsole(`–ê–Ω–∞–ª–∏–∑ DataMatrix (${length} —Å–∏–º–≤–æ–ª–æ–≤): ${cleanCode}`, 'info');
            
            // 1. –°–ê–ú–û–ü–ï–ß–ê–¢–ê–ï–ú–´–ï –°–¢–ò–ö–ï–†–´ - 22 —Å–∏–º–≤–æ–ª–∞
            if (length === 22 && /^\d{22}$/.test(cleanCode)) {
                const id = cleanCode.substring(0, 9); // 9 —Ü–∏—Ñ—Ä ID
                const gtin = cleanCode.substring(9, 22); // 13 —Ü–∏—Ñ—Ä GTIN
                return {
                    type: 'stickers',
                    display: `–°—Ç–∏–∫–µ—Ä (22): ${cleanCode}`,
                    details: `ID: ${id}, GTIN: ${gtin}`,
                    id: id,
                    gtin: gtin
                };
            }
            
            // 2. –£–ö–ó - 30 —Å–∏–º–≤–æ–ª–æ–≤
            else if (length === 30) {
                // –§–æ—Ä–º–∞—Ç: [18 –ª—é–±—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤][9 —Ü–∏—Ñ—Ä –Ω–æ–º–µ—Ä–∞][3 –±—É–∫–≤—ã —Å–µ—Ä–∏–∏]
                const number = cleanCode.substring(18, 27); // –ü–æ–∑–∏—Ü–∏–∏ 19-27 (9 —Ü–∏—Ñ—Ä)
                const series = cleanCode.substring(27, 30); // –ü–æ–∑–∏—Ü–∏–∏ 28-30 (3 –±—É–∫–≤—ã)
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–º–µ—Ä —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ü–∏—Ñ—Ä, –∞ —Å–µ—Ä–∏—è –∏–∑ –±—É–∫–≤
                if (/^\d{9}$/.test(number) && /^[A-Za-z]{3}$/.test(series)) {
                    return {
                        type: 'ukz',
                        display: `–£–ö–ó (30): ${cleanCode}`,
                        details: `–ù–æ–º–µ—Ä: ${number}, –°–µ—Ä–∏—è: ${series}`,
                        number: number,
                        series: series
                    };
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É, –Ω–æ –¥–ª–∏–Ω–∞ 30
                    return {
                        type: 'ukz_generic',
                        display: `–£–ö–ó (30): ${cleanCode}`,
                        details: `–°–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—ã: ${cleanCode.match(/[A-Za-z]/g)?.join('') || '–Ω–µ—Ç'}`,
                        raw: cleanCode
                    };
                }
            }
            
            // 3. –°–†–ï–î–°–¢–í–ê –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò (–°–ò) - 35 —Å–∏–º–≤–æ–ª–æ–≤
            else if (length === 35) {
                // GTIN –Ω–∞ –ø–æ–∑–∏—Ü–∏—è—Ö 4-16 (–∏–Ω–¥–µ–∫—Å—ã 3-15 –≤ JavaScript)
                const gtin = cleanCode.substring(3, 16); // 13 —Ü–∏—Ñ—Ä
                
                if (/^\d{13}$/.test(gtin)) {
                    return {
                        type: 'si',
                        display: `–°–ò (35): ${cleanCode}`,
                        details: `GTIN: ${gtin}`,
                        gtin: gtin,
                        fullCode: cleanCode
                    };
                } else {
                    return {
                        type: 'si_generic',
                        display: `–°–ò (35): ${cleanCode}`,
                        details: `–°–æ–¥–µ—Ä–∂–∏—Ç –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã`,
                        raw: cleanCode
                    };
                }
            }
            
            // 4. GS1 DataMatrix (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã)
            else if (cleanCode.includes('01') || cleanCode.includes('21') || 
                     cleanCode.includes('17') || cleanCode.includes('10')) {
                // –≠—Ç–æ GS1 DataMatrix —Å AI
                const gtinMatch = cleanCode.match(/01(\d{14})/);
                const serialMatch = cleanCode.match(/21([^\u001d]{1,20})/);
                
                return {
                    type: 'gs1',
                    display: `GS1 DataMatrix (${length}): ${cleanCode}`,
                    details: gtinMatch ? `GTIN: ${gtinMatch[1]}` : `–ö–æ–¥ GS1`,
                    gtin: gtinMatch ? gtinMatch[1] : null,
                    serial: serialMatch ? serialMatch[1] : null
                };
            }
            
            // 5. –î—Ä—É–≥–∏–µ DataMatrix
            else if (length >= 20 && length <= 50) {
                return {
                    type: 'other_datamatrix',
                    display: `DataMatrix (${length}): ${cleanCode}`,
                    details: `–î–ª–∏–Ω–∞: ${length} —Å–∏–º–≤–æ–ª–æ–≤`,
                    raw: cleanCode
                };
            }
            
            // –ù–µ DataMatrix
            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        function addResult(text, type, details = '') {
            const emptyMessage = resultsEl.querySelector('.empty-results');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            const item = document.createElement('div');
            item.className = `result-item ${type}-result`;
            
            const number = document.createElement('strong');
            number.textContent = `${scanCount + 1}. `;
            
            const icon = document.createElement('span');
            icon.textContent = type === 'datamatrix' ? 'üì¶ ' : 'üõí ';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            if (details) {
                const detailsSpan = document.createElement('div');
                detailsSpan.style.fontSize = '12px';
                detailsSpan.style.color = '#aaa';
                detailsSpan.style.marginTop = '2px';
                detailsSpan.textContent = details;
                item.appendChild(detailsSpan);
            }
            
            item.appendChild(number);
            item.appendChild(icon);
            item.appendChild(textSpan);
            resultsEl.appendChild(item);
            
            scanCount++;
            scrollToLastResult();
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        function scrollToLastResult() {
            requestAnimationFrame(() => {
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function updateScanHint() {
            if (step === 'datamatrix') {
                scanHintEl.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ DataMatrix';
                scanHintEl.style.color = '#00ff9d';
                scanHintEl.style.borderColor = 'rgba(0, 255, 157, 0.4)';
            } else {
                scanHintEl.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
                scanHintEl.style.color = '#4da6ff';
                scanHintEl.style.borderColor = 'rgba(77, 166, 255, 0.4)';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function onScanSuccess(decodedText) {
            const code = decodedText.trim();
            const now = Date.now();
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 500–º—Å)
            if (code === lastScannedCode && (now - lastScanTime) < 500) {
                logToConsole('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª—å', 'warning');
                return;
            }
            
            lastScannedCode = code;
            lastScanTime = now;
            
            // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
            const hex = Array.from(code)
                .map(c => c.charCodeAt(0).toString(16).padStart(2, '0').toUpperCase())
                .join(' ');
            
            logToConsole(`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: "${code}"`, 'info');
            logToConsole(`–î–ª–∏–Ω–∞: ${code.length}, HEX: ${hex}`, 'info');
            
            let isValid = false;
            let result = null;

            if (step === 'datamatrix') {
                // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º DataMatrix
                result = analyzeDataMatrix(code);
                
                if (result) {
                    isValid = true;
                    addResult(result.display, 'datamatrix', result.details);
                    step = 'barcode';
                    playSound('success');
                    showScanFeedback(true, 'datamatrix');
                    logToConsole(`‚úÖ DataMatrix –ø—Ä–∏–Ω—è—Ç: ${result.type}`, 'success');
                } else {
                    logToConsole(`‚ùå –ù–µ DataMatrix (–¥–ª–∏–Ω–∞ ${code.length})`, 'error');
                    playSound('error');
                }
            } 
            else if (step === 'barcode') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ç—Ä–∏—Ö-–∫–æ–¥—ã
                
                // EAN-13 (13 —Ü–∏—Ñ—Ä)
                if (/^\d{13}$/.test(code)) {
                    isValid = true;
                    addResult(`–®—Ç—Ä–∏—Ö-–∫–æ–¥ EAN-13: ${code}`, 'barcode', `GTIN: ${code}`);
                    step = 'datamatrix';
                    playSound('success');
                    showScanFeedback(true, 'barcode');
                    logToConsole(`‚úÖ –®—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç: EAN-13`, 'success');
                }
                // Code 128 (–±—É–∫–≤—ã+—Ü–∏—Ñ—Ä—ã, 8-20 —Å–∏–º–≤–æ–ª–æ–≤)
                else if (/^[A-Za-z0-9]{8,20}$/.test(code)) {
                    isValid = true;
                    addResult(`–®—Ç—Ä–∏—Ö-–∫–æ–¥: ${code}`, 'barcode');
                    step = 'datamatrix';
                    playSound('success');
                    showScanFeedback(true, 'barcode');
                    logToConsole(`‚úÖ –®—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç: Code 128`, 'success');
                }
                // EAN-8 (8 —Ü–∏—Ñ—Ä)
                else if (/^\d{8}$/.test(code)) {
                    isValid = true;
                    addResult(`–®—Ç—Ä–∏—Ö-–∫–æ–¥ EAN-8: ${code}`, 'barcode');
                    step = 'datamatrix';
                    playSound('success');
                    showScanFeedback(true, 'barcode');
                    logToConsole(`‚úÖ –®—Ç—Ä–∏—Ö-–∫–æ–¥ –ø—Ä–∏–Ω—è—Ç: EAN-8`, 'success');
                }
                else {
                    logToConsole(`‚ùå –ù–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥: ${code}`, 'error');
                    playSound('error');
                }
            }
            
            if (isValid) {
                updateScanHint();
            }
        }

        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        function showScanFeedback(success, type) {
            const color = success ? (type === 'datamatrix' ? '#00ff9d' : '#4da6ff') : '#ff4444';
            
            scanHintEl.style.background = `rgba(${type === 'datamatrix' ? '0,80,0' : '0,0,80'}, 0.9)`;
            scanHintEl.style.boxShadow = `0 4px 15px ${color}40`;
            
            setTimeout(() => {
                scanHintEl.style.background = 'rgba(0, 0, 0, 0.8)';
                scanHintEl.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.5)';
            }, 300);
        }

        // –ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function startScanner() {
            if (isScanning) return;
            
            logToConsole('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞...', 'info');
            
            // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
            const startWithConstraints = (constraints) => {
                html5QrCode.start(
                    constraints,
                    config,
                    onScanSuccess,
                    (error) => {
                        if (!error.includes('NotFoundException')) {
                            logToConsole(`–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ${error}`, 'warning');
                        }
                    }
                ).then(() => {
                    isScanning = true;
                    logToConsole('‚úÖ –°–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
                }).catch(err => {
                    logToConsole(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`, 'error');
                    scanHintEl.textContent = '–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã';
                    scanHintEl.style.color = '#ff4444';
                });
            };
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–∞–º–µ—Ä—É
            Html5Qrcode.getCameras().then(devices => {
                if (devices.length > 0) {
                    // –ò—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                    const backCamera = devices.find(d => 
                        d.label.toLowerCase().includes('back') || 
                        d.label.toLowerCase().includes('rear')
                    );
                    
                    if (backCamera) {
                        logToConsole(`–ù–∞–π–¥–µ–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞: ${backCamera.label}`, 'info');
                        startWithConstraints(backCamera.id);
                    } else {
                        logToConsole(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É: ${devices[0].label}`, 'info');
                        startWithConstraints(devices[0].id);
                    }
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º facingMode –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    logToConsole('–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º facingMode', 'warning');
                    startWithConstraints({ facingMode: "environment" });
                }
            }).catch(err => {
                logToConsole(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä: ${err}`, 'error');
                // –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ —Å facingMode
                startWithConstraints({ facingMode: "environment" });
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('clear-btn').onclick = () => {
            resultsEl.innerHTML = '<div class="empty-results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>';
            step = 'datamatrix';
            scanCount = 0;
            lastScannedCode = '';
            updateScanHint();
            logToConsole('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã', 'info');
        };
        
        document.getElementById('finish-btn').onclick = () => {
            if (isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    logToConsole('–°–∫–∞–Ω–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'info');
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.close();
                    }
                }).catch(err => {
                    logToConsole(`–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${err}`, 'error');
                    if (window.Telegram && Telegram.WebApp) {
                        Telegram.WebApp.close();
                    }
                });
            } else {
                if (window.Telegram && Telegram.WebApp) {
                    Telegram.WebApp.close();
                }
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateScanHint();
        startScanner();

        // CSS –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        const style = document.createElement('style');
        style.textContent = `
            #qr-reader__dashboard_section,
            #qr-reader__camera_permission_button,
            #qr-reader__scan_region,
            #qr-reader__dashboard,
            #qr-reader__camera_selection {
                display: none !important;
            }
            
            #qr-reader video {
                width: 100% !important;
                height: 100% !important;
                object-fit: cover !important;
            }
            
            #qr-reader > * {
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
            }
            
            #qr-reader__scan_region_canvas {
                display: none !important;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
